<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>15&nbsp; Census Data in R: tidycensus – GIS in Public Health: R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/5a_leaflet.html" rel="next">
<link href="../chapters/3e_ColorPalettes.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-f250eac94d6491c1be40d38f350011d3.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-af36289cbe8c9554ebf747dcd00b6f9a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/4a_census_data.html">Maps from APIs</a></li><li class="breadcrumb-item"><a href="../chapters/4a_census_data.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Census Data in R: tidycensus</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">GIS in Public Health: R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to GIS and Public Health</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction to GIS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/1a_GIS_Structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Structure of Spatial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/1b_Projections.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Coordinate Reference Systems and Projections</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/1c_ChoosingCRS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Selecting your Coordinate Reference System</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/1d_Privacy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Privacy and Confidentiality</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/1e_Bias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Bias in spatial data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Types of Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/2a_ShapefileComps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Shapefile structure and file extentions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/2b_Points.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Point Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/2c_Rasters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Rasters</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Map Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/3a_MapParts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Critical Parts of a Map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/3b_Choropleths.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Choropleth Maps</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/3c_Choropleth_Alts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Alternatives to Choropleths</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/3d_Color.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Color and Cartography</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/3e_ColorPalettes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Color Palettes in R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Maps from APIs</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/4a_census_data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Census Data in R: tidycensus</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Interactive Maps</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/5a_leaflet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introduction to Leaflet</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/zz_sf_references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title"><code>sf</code> package: quick references</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/4a_census_data.html">Maps from APIs</a></li><li class="breadcrumb-item"><a href="../chapters/4a_census_data.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Census Data in R: tidycensus</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Census Data in R: tidycensus</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="custom-workflow-for-extracting-census-data" class="level2">
<h2 class="anchored" data-anchor-id="custom-workflow-for-extracting-census-data">Custom workflow for extracting census data</h2>
<p>The following workflow demonstrates a reproducible method for extracting, cleaning, and calculating demographic indicators for counties using the US Census API.</p>
<p>This approach builds upon the core concepts and functions from Kyle Walker, the developer of <code>tidycensus</code> and the online book:</p>
<p><a href="https://walker-data.com/census-r/index.html">Walker Data: Analyzing US Census Data</a></p>
<section id="the-motivation-dont-repeat-yourself" class="level3">
<h3 class="anchored" data-anchor-id="the-motivation-dont-repeat-yourself">The Motivation: “Don’t Repeat Yourself”</h3>
<p>In previous iterations of this work, I found myself constantly violating a core tenet of programming: <strong>DRY (Don’t Repeat Yourself).</strong></p>
<p>I would write a script to fetch Population data, then copy-paste that entire block to fetch Housing data, and copy-paste it again for Income data. I’d get lost in the variable table codes and in interpreting the raw data outputs from <code>get_acs().</code> The result was a script cluttered with repetitive logic. If I decided to change how I calculated a percentage or handled a missing value, I had to hunt down and fix it in five different places.</p>
<p>Maybe I’m just really bad at utilizing the existing powers and processes captured in <code>tidycensus().</code></p>
<p>Regardless, here it is…</p>
<p>Instead of writing repetitive code for every subject (Housing, Income, Population), we created a <strong>custom “topic-based” pipeline. </strong> The pipeline abstracts logic into a standardized process that loops through metadata files: handling the heavy lifting automatically, consistently, and all in one place.</p>
<p>Primary Resource:</p>
<hr>
</section>
</section>
<section id="setup-project-scope-and-api-configuration" class="level2">
<h2 class="anchored" data-anchor-id="setup-project-scope-and-api-configuration">Setup: Project Scope and API Configuration</h2>
<p>To interact with the Census Bureau’s API, we use the <code>tidycensus</code> package. This requires a <strong>valid API key</strong>.</p>
<ul>
<li><p><strong>Prerequisites:</strong> You must request a free key from <strong>http://api.census.gov/data/key_signup.html.</strong></p></li>
<li><p><strong>Security Note:</strong> We use the config package to store the API key securely, rather than hard-coding it into the script.</p></li>
</ul>
<p>We bring in other required libraries, and we also define our project scope and global variables used throughout.</p>
<p>By setting the state, target counties, and years in the global environment, we ensure consistent querying across all topics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(config)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="do">## these options below a) forces R to print full decimals </span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="do">###-- without defaulting to scientific notation</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="do">###-- and b) caches tigris data for quicker uploads</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">99999</span>, <span class="at">tigris_use_cache =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="do">## after safely storing your key in a .config file, </span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="do">###-- read it in like this</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>census_key <span class="ot">&lt;-</span> config<span class="sc">::</span><span class="fu">get</span>(<span class="st">"census_key"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="do">## , then you can use that variable to set the key:</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(census_key, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="do">## set global variables</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>state_code   <span class="ot">&lt;-</span> <span class="st">"MT"</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>counties <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Lewis and Clark"</span>, <span class="st">"Jefferson"</span>, <span class="st">"Broadwater"</span>, <span class="st">"Powell"</span>, <span class="st">"Meagher"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>target_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2013</span>, <span class="dv">2018</span>, <span class="dv">2023</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setup-creating-the-variable-maps" class="level2">
<h2 class="anchored" data-anchor-id="setup-creating-the-variable-maps">Setup: Creating the Variable Maps</h2>
<p>Before we can fetch data, we need to tell R exactly what to fetch and how to treat it. Instead of hard-coding Census variables (like DP05_0001E) deeply into our scripts, we define them in “<strong>Variable Map</strong>” files.</p>
<p>These are CSV files that act as a “<strong>Data Dictionary</strong>.”</p>
<p>They define:</p>
<ul>
<li><p><strong>label:</strong> The human-readable name for your chart (e.g., “Population Under 5”).</p></li>
<li><p><strong>variable:</strong> The specific US Census code.</p></li>
<li><p><strong>stat_type:</strong> Instructions for the calculator (is it a count, a currency, or a pre-calculated percent?).</p></li>
<li><p><strong>denominator:</strong> Which variable acts as the “Total” for calculating percentages (e.g., Total Population).</p></li>
</ul>
<p>You can create these CSVs using <code>tribble()</code> in R and save them to a directory. For example, I stored all of mine in a directory called “<strong>variable_maps/</strong>”</p>
<p>You can call this directory and it’s sub-files however you want to. You can change the names of the variables. But note that the rest of the script below is based specifically around these column keys.</p>
<p>Here is a small example of how a variable map .csv is created and structured for the topic “Population”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pop_ref_data <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>label,                          <span class="sc">~</span>variable,       <span class="sc">~</span>stat_type,  <span class="sc">~</span>denominator,    <span class="sc">~</span>category,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- BASIC COUNTS ---</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total Population"</span>,              <span class="st">"B01003_001"</span>,    <span class="st">"count"</span>,     <span class="cn">NA</span>,              <span class="st">"Population"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Median Age"</span>,                    <span class="st">"B01002_001"</span>,    <span class="st">"number"</span>,    <span class="cn">NA</span>,              <span class="st">"Population"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- AGE GROUPS  ---</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop Under 5 Years"</span>,             <span class="st">"S0101_C01_002"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop 5 to 17 Years"</span>,             <span class="st">"S0101_C01_003"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop 18 to 24 Years"</span>,            <span class="st">"S0101_C01_004"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>, </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop 65 Years and Over"</span>,         <span class="st">"S0101_C01_030"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- DENOMINATORS ---</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total Pop (Denom)"</span>,             <span class="st">"B01003_001"</span>,    <span class="st">"denom"</span>,     <span class="cn">NA</span>,              <span class="st">"Population"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total Pop (Age Denom)"</span>,         <span class="st">"S0101_C01_001"</span>, <span class="st">"denom"</span>,     <span class="cn">NA</span>,              <span class="st">"Population"</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Save this variable map df to your directory</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(pop_ref_data, <span class="fu">here</span>(<span class="st">"variable_maps/population_vars_map.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="the-core-logic-fetching-mapped-acs-census-data" class="level2">
<h2 class="anchored" data-anchor-id="the-core-logic-fetching-mapped-acs-census-data">The Core Logic: Fetching “mapped” ACS Census Data</h2>
<p>The standard <code>get_acs()</code> function is powerful but returns raw data.</p>
<p>For a dashboard or report, we need more than just counts; it is super helpful to also return much needed context (human-readable table ID labels, general categories, meta-data on the type of estimate it is, what denominator or “universe” is used to calculate it, etc…).</p>
<p>Enter… custom function: <code>get_labeled_acs()</code></p>
<section id="how-it-works" class="level3">
<h3 class="anchored" data-anchor-id="how-it-works">How it works:</h3>
<ul>
<li><p><strong>Splits Requests:</strong> It separates variables into batches (Profile DP, Subject S, and Base B) to prevent API errors, as different table types cannot always be requested together.</p></li>
<li><p><strong>Iterates Over Years:</strong> It automatically loops through the years defined in our setup (e.g., 2013, 2018, 2023).</p></li>
<li><p><strong>Joins Metadata:</strong> Crucially, it merges the API results with our “Variable Maps” (CSVs). This attaches the human-readable labels (e.g., “Total Population”) and calculation instructions (e.g., “Denominator is DP05_0001”) directly to the data.</p></li>
</ul>
<p><strong><code>get_labeld_acs()</code></strong> function:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>get_labeled_acs <span class="ot">&lt;-</span> <span class="cf">function</span>(ref_table, counties, <span class="at">state =</span> <span class="st">"MT"</span>, <span class="at">years =</span> target_years, <span class="at">survey_type =</span> <span class="st">"acs5"</span>, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">geo_level =</span> <span class="st">"county"</span>) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Split variables by type to create batches</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  vars_dp <span class="ot">&lt;-</span> ref_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_starts</span>(variable, <span class="st">"DP"</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(variable)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  vars_s  <span class="ot">&lt;-</span> ref_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_starts</span>(variable, <span class="st">"S"</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(variable)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  vars_b  <span class="ot">&lt;-</span> ref_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_starts</span>(variable, <span class="st">"DP"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_starts</span>(variable, <span class="st">"S"</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(variable)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Iterate through years</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(years, <span class="cf">function</span>(y) {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"&gt;&gt;&gt; Fetching data for"</span>, y, <span class="st">"..."</span>))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- First batch: detailed table variables (`B` prefix) ---</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(vars_b) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({ </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        results_list[[<span class="st">"B"</span>]] <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">geography   =</span> geo_level, </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">state       =</span> state, </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">county      =</span> counties, </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>          <span class="at">year        =</span> y, </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">survey      =</span> survey_type,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">variables   =</span> vars_b, </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">output      =</span> <span class="st">"tidy"</span>, </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">cache_table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">show_call   =</span> <span class="cn">FALSE</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"   [!] B-Table batch failed for"</span>, y, <span class="st">":"</span>, e<span class="sc">$</span>message)))</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Second batch: data profile variables (`DP` prefix) ---</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(vars_dp) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({ </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        results_list[[<span class="st">"DP"</span>]] <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">geography   =</span> geo_level, </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">state       =</span> state, </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">county      =</span> counties, </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">year        =</span> y, </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">survey      =</span> survey_type,</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>          <span class="at">variables   =</span> vars_dp, </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>          <span class="at">output      =</span> <span class="st">"tidy"</span>, </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>          <span class="at">cache_table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">show_call   =</span> <span class="cn">FALSE</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"   [!] DP-Table batch failed for"</span>, y, <span class="st">":"</span>, e<span class="sc">$</span>message)))</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Thrid batch: subject table variables (`S` prefix) ---</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(vars_s) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({ </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        results_list[[<span class="st">"S"</span>]] <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">geography   =</span> geo_level, </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">state       =</span> state, </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">county      =</span> counties, </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">year        =</span> y, </span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">survey      =</span> survey_type,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">variables   =</span> vars_s, </span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">output      =</span> <span class="st">"tidy"</span>, </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">cache_table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">show_call   =</span> <span class="cn">FALSE</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"   [!] S-Table batch failed for"</span>, y, <span class="st">":"</span>, e<span class="sc">$</span>message)))</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- SAFETY CHECK ---</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If ALL batches failed, we can't continue for this year.</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(results_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"!!! All batches failed for year"</span>, y))</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all successful data pulls</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    combined_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_list)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a grid of all Counties x all Variables in the map</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="do">##-- variables from failed batches still appear in the df (filled as NA)</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    distinct_geos <span class="ot">&lt;-</span> combined_data <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(GEOID, NAME)</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    full_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>      distinct_geos,</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable =</span> ref_table<span class="sc">$</span>variable</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final Join and Clean</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    full_grid <span class="sc">%&gt;%</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(combined_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"NAME"</span>, <span class="st">"variable"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> y, <span class="at">join_id =</span> <span class="fu">str_remove</span>(variable, <span class="st">"E$"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>      <span class="do">##-- append the 'metadata' labels from our custom reference tables</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(ref_table <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">join_id =</span> <span class="fu">str_remove</span>(variable, <span class="st">"E$"</span>)), </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">"join_id"</span>, <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> <span class="fu">coalesce</span>(variable.y, variable.x),</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">census_survey =</span> <span class="st">"acs"</span>,</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">survey_type =</span> survey_type</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        GEOID, NAME, census_survey, survey_type,</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        year, category, label, variable, estimate, </span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        moe, stat_type, denominator</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="the-dynamic-percent-calculation-logic" class="level2">
<h2 class="anchored" data-anchor-id="the-dynamic-percent-calculation-logic">The Dynamic Percent Calculation Logic</h2>
<p>Raw census counts (e.g., “250 people”) are often less useful for comparison than percentages (e.g., “12% of the population”).</p>
<p>Enter… custom function: <code>calc_acs_percents()</code></p>
<section id="how-it-works-1" class="level3">
<h3 class="anchored" data-anchor-id="how-it-works-1">How it works</h3>
<ul>
<li><p>**Performs a “self-join:** The dataframe looks up its own data. For every row marked as a”count” (e.g., Children in Poverty), it finds the corresponding “denominator” value (e.g., Total Children) for that specific county and year.</p></li>
<li><p><strong>Calculates the percent:</strong> (Estimate / Denominator) * 100</p></li>
<li><p><strong>Ignores other data types:</strong> this only selects the estimates that are true “counts,” and ignores all others like rates, ratios, percents, or currency (e.g., “Unemployment Rate”, “Median Income”, “Percent of population in poverty”)</p></li>
</ul>
<p><strong><code>calc_acs_percents()</code></strong> function:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>calc_acs_percents <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"year"</span>, <span class="st">"variable"</span>, <span class="st">"estimate"</span>, <span class="st">"denominator"</span>, <span class="st">"stat_type"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Dataframe is missing required columns (denominator, stat_type, etc.)"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- isolate just the values needed to serve as denominators</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  denom_lookup <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(GEOID, year, variable, <span class="at">denom_value =</span> estimate) <span class="sc">%&gt;%</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(GEOID, year, variable, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- join and calculate based on the 'denominator' code column</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  df_calculated <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(denom_lookup, </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"year"</span>, <span class="st">"denominator"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">est_percent =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="do">##-- if the estimate is a 'count' -&gt; calculate the %</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        stat_type <span class="sc">==</span> <span class="st">"count"</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(denom_value) <span class="sc">&amp;</span> denom_value <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> (estimate <span class="sc">/</span> denom_value) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="do">##-- otherwise, don't... just return NA</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">est_percent =</span> <span class="fu">round</span>(est_percent, <span class="dv">2</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_calculated)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="automation-the-master-processor" class="level2">
<h2 class="anchored" data-anchor-id="automation-the-master-processor">Automation: The Master Processor</h2>
<p>To avoid repeating code, we wrap the previous two steps into a single “Master Processor”</p>
<p>Enter… custom function: <code>build_acs_topic()</code></p>
<p>This function acts as the conductor of the final pipeline. It requires two specific inputs:</p>
<ul>
<li><p><strong>Topic Name:</strong> A label for the dataset (e.g., “Housing”)</p></li>
<li><p><strong>Variable Map Filename:</strong> The specific CSV file in the “<strong>variable_maps/</strong>” folder (or whatever you called it) that corresponds to that topic (e.g., housing_vars_map.csv).</p></li>
</ul>
<p><strong>Important:</strong> The function relies on the “map_filename” to find the correct “instructions” for the API. It validates that the CSV exists and contains the necessary columns (stat_type, denominator) before attempting to fetch any data.</p>
<section id="how-it-works-2" class="level3">
<h3 class="anchored" data-anchor-id="how-it-works-2">How it works:</h3>
<ul>
<li><p>Validates the map file.</p></li>
<li><p>Runs <code>get_labeled_acs()</code> to pull the raw data</p></li>
<li><p>Runs <code>calc_acs_percents()</code> to calculate derived metrics</p></li>
<li><p>Returns a fully polished, ready-to-analyze dataset</p></li>
</ul>
<p>By standardizing this process, you ensure that “Housing” data is treated with the exact same mathematical rigor as “Income” data, eliminating the risk of copy-paste errors between topics.</p>
<p><strong><code>build_acs_topic()</code></strong> function:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>build_acs_topic <span class="ot">&lt;-</span> <span class="cf">function</span>(topic_name, map_filename, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                            counties, state, years, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">survey_type =</span> <span class="st">"acs5"</span>, </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">geo_level =</span> <span class="st">"county"</span>) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  full_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"variable_maps"</span>, map_filename)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== PROCESSING TOPIC:"</span>, topic_name, <span class="st">"("</span>, survey_type, <span class="st">") ==="</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(full_path)) {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Map file not found:"</span>, full_path))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  ref_table <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(full_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"stat_type"</span>, <span class="st">"denominator"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(ref_table))) {</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"CSV is missing 'stat_type' or 'denominator' columns!"</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- fetch</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  raw_data <span class="ot">&lt;-</span> <span class="fu">get_labeled_acs</span>(ref_table, counties, state, years, survey_type, geo_level)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(raw_data)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Columns returned by fetch:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(raw_data), <span class="at">collapse=</span><span class="st">", "</span>)))</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- final output</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  clean_data <span class="ot">&lt;-</span> <span class="fu">calc_acs_percents</span>(raw_data)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Successfully processed"</span>, <span class="fu">nrow</span>(clean_data), <span class="st">"rows."</span>))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(clean_data)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="putting-it-all-together-running-the-final-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together-running-the-final-pipeline">Putting it All Together: Running the Final Pipeline</h2>
<p>This is the “Control Center” of the script.</p>
<p>We first define a list of the topics we want to process.</p>
<p>If we ever need to add a new category (e.g., “Transportation”), we simply create a new CSV map and add it here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>topic_list <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span>topic,   <span class="sc">~</span>map_filename,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Population"</span>  ,  <span class="st">"population_vars_map.csv"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Housing"</span>     ,  <span class="st">"housing_vars_map.csv"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Income"</span>      ,  <span class="st">"income_vars_map.csv"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Education"</span>   ,  <span class="st">"education_vars_map.csv"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Employment"</span>  ,  <span class="st">"employment_vars_map.csv"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Health"</span>      ,  <span class="st">"health_vars_map.csv"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we simply run the code below, using <code>purrr::map2()</code> to iterate through this list, processing every topic automatically.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">##-- county-level data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cnty_census_data <span class="ot">&lt;-</span> topic_list <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2</span>(topic, map_filename, <span class="cf">function</span>(t, f) {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">build_acs_topic</span>(t, f, counties, state_code, target_years)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="do">##-- census tract data</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>tract_census_data <span class="ot">&lt;-</span> topic_list <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2</span>(topic, map_filename, <span class="cf">function</span>(t, f) {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">build_acs_topic</span>(t, f, <span class="at">counties =</span> lc_county, state_code, target_years, <span class="at">geo_level =</span> <span class="st">"tract"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  }))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="the-final-outputs-and-storage" class="level3">
<h3 class="anchored" data-anchor-id="the-final-outputs-and-storage">The Final Outputs and Storage</h3>
<p>The result of the pipeline is a <strong>nested list</strong> containing all our data.</p>
<p>We can now:</p>
<ul>
<li><p>Extract individual datasets (e.g., final_pop) for specific analysis.</p></li>
<li><p>Bind them together into a single combined dataframe</p></li>
<li><p>Export to CSV for future use like bringing them into a Shiny dashboard, Power BI, etc.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a named list for easy access</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cnty_results_5yr  <span class="ot">&lt;-</span> <span class="fu">setNames</span>(cnty_census_data<span class="sc">$</span>data, cnty_census_data<span class="sc">$</span>topic)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>tract_results_5yr <span class="ot">&lt;-</span> <span class="fu">setNames</span>(tract_census_data<span class="sc">$</span>data, tract_census_data<span class="sc">$</span>topic)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine them all into a single df</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>cnty_census_5yr_df  <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(cnty_results_5yr) </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>tract_census_5yr_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(tract_results_5yr) </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>complete_census_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(cnty_census_5yr_df, tract_census_5yr_df) <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="do">##-- another custom function that calculates broader education categories like "BS or Higher"</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_education_summary</span>() </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="do">##-- you can also access/save them directly by name if you want</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>cnty_pop   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Population"</span>]]</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>cnty_house <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Housing"</span>]]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>cnty_inc   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Income"</span>]]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>cnty_edu   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Education"</span>]]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>cnty_emp   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Employment"</span>]]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>cnty_hlth  <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Health"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save it for later use, bring in the other applications, etc...</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  complete_census_df, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">here</span>(<span class="st">"_data/census_data/complete_census_df.csv"</span>), </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/3e_ColorPalettes.html" class="pagination-link" aria-label="Color Palettes in R">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Color Palettes in R</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/5a_leaflet.html" class="pagination-link" aria-label="Introduction to Leaflet">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introduction to Leaflet</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb10" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="an">eval:</span><span class="co"> false</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu"># Census Data in R: tidycensus</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Custom workflow for extracting census data</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>The following workflow demonstrates a reproducible method for extracting, cleaning, and calculating demographic indicators for counties using the US Census API.</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>This approach builds upon the core concepts and functions from Kyle Walker, the developer of <span class="in">`tidycensus`</span>  and the online book:</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Walker Data: Analyzing US Census Data</span><span class="co">](https://walker-data.com/census-r/index.html)</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Motivation: "Don't Repeat Yourself"</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>In previous iterations of this work, I found myself constantly violating a core tenet of programming: **DRY (Don't Repeat Yourself).**</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>I would write a script to fetch Population data, then copy-paste that entire block to fetch Housing data, and copy-paste it again for Income data. I'd get lost in the variable table codes and in interpreting the raw data outputs from <span class="in">`get_acs().`</span> The result was a script cluttered with repetitive logic. If I decided to change how I calculated a percentage or handled a missing value, I had to hunt down and fix it in five different places.</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>Maybe I'm just really bad at utilizing the existing powers and processes captured in <span class="in">`tidycensus().`</span> </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>Regardless, here it is...</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>Instead of writing repetitive code for every subject (Housing, Income, Population), we created a **custom "topic-based" pipeline. ** The pipeline abstracts logic into a standardized process that loops through metadata files: handling the heavy lifting automatically, consistently, and all in one place.</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>Primary Resource: </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>------------------</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup: Project Scope and API Configuration</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>To interact with the Census Bureau's API, we use the <span class="in">`tidycensus`</span> package. </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>This requires a **valid API key**.</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Prerequisites:** You must request a free key from **http://api.census.gov/data/key_signup.html.**</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Security Note:** We use the config package to store the API key securely, rather than hard-coding it into the script.</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>We bring in other required libraries, and we also define our project scope and global variables used throughout.</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>By setting the state, target counties, and years in the global environment, we ensure consistent querying across all topics.</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(config)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="do">## these options below a) forces R to print full decimals </span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="do">###-- without defaulting to scientific notation</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="do">###-- and b) caches tigris data for quicker uploads</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">99999</span>, <span class="at">tigris_use_cache =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="do">## after safely storing your key in a .config file, </span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a><span class="do">###-- read it in like this</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>census_key <span class="ot">&lt;-</span> config<span class="sc">::</span><span class="fu">get</span>(<span class="st">"census_key"</span>)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a><span class="do">## , then you can use that variable to set the key:</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(census_key, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="do">## set global variables</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>state_code   <span class="ot">&lt;-</span> <span class="st">"MT"</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>counties <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Lewis and Clark"</span>, <span class="st">"Jefferson"</span>, <span class="st">"Broadwater"</span>, <span class="st">"Powell"</span>, <span class="st">"Meagher"</span>)</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>target_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2013</span>, <span class="dv">2018</span>, <span class="dv">2023</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup: Creating the Variable Maps</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>Before we can fetch data, we need to tell R exactly what to fetch and how to treat it. Instead of hard-coding Census variables (like DP05_0001E) deeply into our scripts, we define them in "**Variable Map**" files.</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>These are CSV files that act as a "**Data Dictionary**." </span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>They define:</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**label:** The human-readable name for your chart (e.g., "Population Under 5").</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**variable:** The specific US Census code.</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**stat_type:** Instructions for the calculator (is it a count, a currency, or a pre-calculated percent?).</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**denominator:** Which variable acts as the "Total" for calculating percentages (e.g., Total Population).</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>You can create these CSVs using <span class="in">`tribble()`</span> in R and save them to a directory. For example, I stored all of mine in a directory called "**variable_maps/**" </span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>You can call this directory and it's sub-files however you want to. You can change the names of the variables. But note that the rest of the script below is based specifically around these column keys. </span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>Here is a small example of how a variable map .csv is created and structured for the topic "Population"</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>pop_ref_data <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>label,                          <span class="sc">~</span>variable,       <span class="sc">~</span>stat_type,  <span class="sc">~</span>denominator,    <span class="sc">~</span>category,</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- BASIC COUNTS ---</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total Population"</span>,              <span class="st">"B01003_001"</span>,    <span class="st">"count"</span>,     <span class="cn">NA</span>,              <span class="st">"Population"</span>,</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Median Age"</span>,                    <span class="st">"B01002_001"</span>,    <span class="st">"number"</span>,    <span class="cn">NA</span>,              <span class="st">"Population"</span>,</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- AGE GROUPS  ---</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop Under 5 Years"</span>,             <span class="st">"S0101_C01_002"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>,</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop 5 to 17 Years"</span>,             <span class="st">"S0101_C01_003"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>, </span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop 18 to 24 Years"</span>,            <span class="st">"S0101_C01_004"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>, </span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pop 65 Years and Over"</span>,         <span class="st">"S0101_C01_030"</span>, <span class="st">"count"</span>,     <span class="st">"S0101_C01_001"</span>, <span class="st">"Population"</span>, </span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- DENOMINATORS ---</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total Pop (Denom)"</span>,             <span class="st">"B01003_001"</span>,    <span class="st">"denom"</span>,     <span class="cn">NA</span>,              <span class="st">"Population"</span>,</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total Pop (Age Denom)"</span>,         <span class="st">"S0101_C01_001"</span>, <span class="st">"denom"</span>,     <span class="cn">NA</span>,              <span class="st">"Population"</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Save this variable map df to your directory</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(pop_ref_data, <span class="fu">here</span>(<span class="st">"variable_maps/population_vars_map.csv"</span>))</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>-------------</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Core Logic: Fetching "mapped" ACS Census Data</span></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>The standard <span class="in">`get_acs()`</span> function is powerful but returns raw data. </span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>For a dashboard or report, we need more than just counts; it is super helpful to also return much needed context (human-readable table ID labels, general categories, meta-data on the type of estimate it is, what denominator or "universe" is used to calculate it, etc...).</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>Enter... custom function: <span class="in">`get_labeled_acs()`</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a><span class="fu">### How it works:</span></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Splits Requests:** It separates variables into batches (Profile DP, Subject S, and Base B) to prevent API errors, as different table types cannot always be requested together.</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Iterates Over Years:** It automatically loops through the years defined in our setup (e.g., 2013, 2018, 2023).</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Joins Metadata:** Crucially, it merges the API results with our "Variable Maps" (CSVs). This attaches the human-readable labels (e.g., "Total Population") and calculation instructions (e.g., "Denominator is DP05_0001") directly to the data.</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>**`get_labeld_acs()`** function:   </span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>get_labeled_acs <span class="ot">&lt;-</span> <span class="cf">function</span>(ref_table, counties, <span class="at">state =</span> <span class="st">"MT"</span>, <span class="at">years =</span> target_years, <span class="at">survey_type =</span> <span class="st">"acs5"</span>, </span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>                            <span class="at">geo_level =</span> <span class="st">"county"</span>) {</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Split variables by type to create batches</span></span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>  vars_dp <span class="ot">&lt;-</span> ref_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_starts</span>(variable, <span class="st">"DP"</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(variable)</span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>  vars_s  <span class="ot">&lt;-</span> ref_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_starts</span>(variable, <span class="st">"S"</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(variable)</span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>  vars_b  <span class="ot">&lt;-</span> ref_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_starts</span>(variable, <span class="st">"DP"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_starts</span>(variable, <span class="st">"S"</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(variable)</span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Iterate through years</span></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(years, <span class="cf">function</span>(y) {</span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"&gt;&gt;&gt; Fetching data for"</span>, y, <span class="st">"..."</span>))</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>    results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- First batch: detailed table variables (`B` prefix) ---</span></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(vars_b) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({ </span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>        results_list[[<span class="st">"B"</span>]] <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>          <span class="at">geography   =</span> geo_level, </span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>          <span class="at">state       =</span> state, </span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>          <span class="at">county      =</span> counties, </span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>          <span class="at">year        =</span> y, </span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>          <span class="at">survey      =</span> survey_type,</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>          <span class="at">variables   =</span> vars_b, </span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>          <span class="at">output      =</span> <span class="st">"tidy"</span>, </span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>          <span class="at">cache_table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>          <span class="at">show_call   =</span> <span class="cn">FALSE</span></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"   [!] B-Table batch failed for"</span>, y, <span class="st">":"</span>, e<span class="sc">$</span>message)))</span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Second batch: data profile variables (`DP` prefix) ---</span></span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(vars_dp) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({ </span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>        results_list[[<span class="st">"DP"</span>]] <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>          <span class="at">geography   =</span> geo_level, </span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>          <span class="at">state       =</span> state, </span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>          <span class="at">county      =</span> counties, </span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>          <span class="at">year        =</span> y, </span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>          <span class="at">survey      =</span> survey_type,</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>          <span class="at">variables   =</span> vars_dp, </span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>          <span class="at">output      =</span> <span class="st">"tidy"</span>, </span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>          <span class="at">cache_table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>          <span class="at">show_call   =</span> <span class="cn">FALSE</span></span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"   [!] DP-Table batch failed for"</span>, y, <span class="st">":"</span>, e<span class="sc">$</span>message)))</span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Thrid batch: subject table variables (`S` prefix) ---</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(vars_s) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({ </span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a>        results_list[[<span class="st">"S"</span>]] <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>          <span class="at">geography   =</span> geo_level, </span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>          <span class="at">state       =</span> state, </span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a>          <span class="at">county      =</span> counties, </span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>          <span class="at">year        =</span> y, </span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>          <span class="at">survey      =</span> survey_type,</span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>          <span class="at">variables   =</span> vars_s, </span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>          <span class="at">output      =</span> <span class="st">"tidy"</span>, </span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>          <span class="at">cache_table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>          <span class="at">show_call   =</span> <span class="cn">FALSE</span></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"   [!] S-Table batch failed for"</span>, y, <span class="st">":"</span>, e<span class="sc">$</span>message)))</span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- SAFETY CHECK ---</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If ALL batches failed, we can't continue for this year.</span></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(results_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"!!! All batches failed for year"</span>, y))</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all successful data pulls</span></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>    combined_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_list)</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a grid of all Counties x all Variables in the map</span></span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>    <span class="do">##-- variables from failed batches still appear in the df (filled as NA)</span></span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>    distinct_geos <span class="ot">&lt;-</span> combined_data <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(GEOID, NAME)</span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>    full_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a>      distinct_geos,</span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable =</span> ref_table<span class="sc">$</span>variable</span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final Join and Clean</span></span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a>    full_grid <span class="sc">%&gt;%</span></span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(combined_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"NAME"</span>, <span class="st">"variable"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> y, <span class="at">join_id =</span> <span class="fu">str_remove</span>(variable, <span class="st">"E$"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a>      <span class="do">##-- append the 'metadata' labels from our custom reference tables</span></span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(ref_table <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">join_id =</span> <span class="fu">str_remove</span>(variable, <span class="st">"E$"</span>)), </span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">"join_id"</span>, <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> <span class="fu">coalesce</span>(variable.y, variable.x),</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>        <span class="at">census_survey =</span> <span class="st">"acs"</span>,</span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>        <span class="at">survey_type =</span> survey_type</span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a>        GEOID, NAME, census_survey, survey_type,</span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a>        year, category, label, variable, estimate, </span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a>        moe, stat_type, denominator</span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a>---------------------</span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Dynamic Percent Calculation Logic</span></span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a>Raw census counts (e.g., "250 people") are often less useful for comparison than percentages (e.g., "12% of the population").</span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a>Enter... custom function: <span class="in">`calc_acs_percents()`</span> </span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a><span class="fu">### How it works</span></span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Performs a "self-join:** The dataframe looks up its own data. For every row marked as a "count" (e.g., Children in Poverty), it finds the corresponding "denominator" value (e.g., Total Children) for that specific county and year.</span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Calculates the percent:** (Estimate / Denominator) * 100</span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Ignores other data types:** this only selects the estimates that are true "counts," and ignores all others like rates, ratios, percents, or currency (e.g., "Unemployment Rate", "Median Income", "Percent of population in poverty") </span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a>**`calc_acs_percents()`** function:   </span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a>calc_acs_percents <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"year"</span>, <span class="st">"variable"</span>, <span class="st">"estimate"</span>, <span class="st">"denominator"</span>, <span class="st">"stat_type"</span>)</span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Dataframe is missing required columns (denominator, stat_type, etc.)"</span>)</span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- isolate just the values needed to serve as denominators</span></span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a>  denom_lookup <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(GEOID, year, variable, <span class="at">denom_value =</span> estimate) <span class="sc">%&gt;%</span></span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(GEOID, year, variable, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) </span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- join and calculate based on the 'denominator' code column</span></span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a>  df_calculated <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(denom_lookup, </span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"year"</span>, <span class="st">"denominator"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a>      <span class="at">est_percent =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a>        <span class="do">##-- if the estimate is a 'count' -&gt; calculate the %</span></span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a>        stat_type <span class="sc">==</span> <span class="st">"count"</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(denom_value) <span class="sc">&amp;</span> denom_value <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> (estimate <span class="sc">/</span> denom_value) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a>        <span class="do">##-- otherwise, don't... just return NA</span></span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a>      <span class="at">est_percent =</span> <span class="fu">round</span>(est_percent, <span class="dv">2</span>)</span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_calculated)</span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a>-------------------</span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a><span class="fu">## Automation: The Master Processor</span></span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a>To avoid repeating code, we wrap the previous two steps into a single "Master Processor" </span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a>Enter... custom function: <span class="in">`build_acs_topic()`</span></span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a>This function acts as the conductor of the final pipeline. It requires two specific inputs:</span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Topic Name:** A label for the dataset (e.g., "Housing")</span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>**Variable Map Filename:** The specific CSV file in the "**variable_maps/**" folder (or whatever you called it) that corresponds to that topic (e.g., housing_vars_map.csv). </span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>**Important:** The function relies on the "map_filename" to find the correct "instructions" for the API. It validates that the CSV exists and contains the necessary columns (stat_type, denominator) before attempting to fetch any data.</span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a><span class="fu">### How it works:</span></span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Validates the map file.</span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Runs <span class="in">`get_labeled_acs()`</span> to pull the raw data</span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Runs <span class="in">`calc_acs_percents()`</span> to calculate derived metrics</span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Returns a fully polished, ready-to-analyze dataset</span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a>By standardizing this process, you ensure that "Housing" data is treated with the exact same mathematical rigor as "Income" data, eliminating the risk of copy-paste errors between topics.</span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a>**`build_acs_topic()`** function:  </span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a>build_acs_topic <span class="ot">&lt;-</span> <span class="cf">function</span>(topic_name, map_filename, </span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a>                            counties, state, years, </span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a>                            <span class="at">survey_type =</span> <span class="st">"acs5"</span>, </span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a>                            <span class="at">geo_level =</span> <span class="st">"county"</span>) {</span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a>  full_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"variable_maps"</span>, map_filename)</span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== PROCESSING TOPIC:"</span>, topic_name, <span class="st">"("</span>, survey_type, <span class="st">") ==="</span>))</span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(full_path)) {</span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Map file not found:"</span>, full_path))</span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a>  ref_table <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(full_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"stat_type"</span>, <span class="st">"denominator"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(ref_table))) {</span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"CSV is missing 'stat_type' or 'denominator' columns!"</span>)</span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- fetch</span></span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a>  raw_data <span class="ot">&lt;-</span> <span class="fu">get_labeled_acs</span>(ref_table, counties, state, years, survey_type, geo_level)</span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(raw_data)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Columns returned by fetch:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(raw_data), <span class="at">collapse=</span><span class="st">", "</span>)))</span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a>  <span class="do">##-- final output</span></span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a>  clean_data <span class="ot">&lt;-</span> <span class="fu">calc_acs_percents</span>(raw_data)</span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Successfully processed"</span>, <span class="fu">nrow</span>(clean_data), <span class="st">"rows."</span>))</span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(clean_data)</span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-419"><a href="#cb10-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-420"><a href="#cb10-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-421"><a href="#cb10-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-422"><a href="#cb10-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-423"><a href="#cb10-423" aria-hidden="true" tabindex="-1"></a>----------------</span>
<span id="cb10-424"><a href="#cb10-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-425"><a href="#cb10-425" aria-hidden="true" tabindex="-1"></a><span class="fu">## Putting it All Together: Running the Final Pipeline</span></span>
<span id="cb10-426"><a href="#cb10-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-427"><a href="#cb10-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-428"><a href="#cb10-428" aria-hidden="true" tabindex="-1"></a>This is the "Control Center" of the script. </span>
<span id="cb10-429"><a href="#cb10-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-430"><a href="#cb10-430" aria-hidden="true" tabindex="-1"></a>We first define a list of the topics we want to process. </span>
<span id="cb10-431"><a href="#cb10-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-432"><a href="#cb10-432" aria-hidden="true" tabindex="-1"></a>If we ever need to add a new category (e.g., "Transportation"), we simply create a new CSV map and add it here. </span>
<span id="cb10-433"><a href="#cb10-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-434"><a href="#cb10-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-435"><a href="#cb10-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-438"><a href="#cb10-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-439"><a href="#cb10-439" aria-hidden="true" tabindex="-1"></a>topic_list <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb10-440"><a href="#cb10-440" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span>topic,   <span class="sc">~</span>map_filename,</span>
<span id="cb10-441"><a href="#cb10-441" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Population"</span>  ,  <span class="st">"population_vars_map.csv"</span>,</span>
<span id="cb10-442"><a href="#cb10-442" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Housing"</span>     ,  <span class="st">"housing_vars_map.csv"</span>,</span>
<span id="cb10-443"><a href="#cb10-443" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Income"</span>      ,  <span class="st">"income_vars_map.csv"</span>,</span>
<span id="cb10-444"><a href="#cb10-444" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Education"</span>   ,  <span class="st">"education_vars_map.csv"</span>,</span>
<span id="cb10-445"><a href="#cb10-445" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Employment"</span>  ,  <span class="st">"employment_vars_map.csv"</span>,</span>
<span id="cb10-446"><a href="#cb10-446" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Health"</span>      ,  <span class="st">"health_vars_map.csv"</span></span>
<span id="cb10-447"><a href="#cb10-447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-448"><a href="#cb10-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-449"><a href="#cb10-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-450"><a href="#cb10-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-451"><a href="#cb10-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-452"><a href="#cb10-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-453"><a href="#cb10-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-454"><a href="#cb10-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-455"><a href="#cb10-455" aria-hidden="true" tabindex="-1"></a>Then we simply run the code below, using <span class="in">`purrr::map2()`</span> to iterate through this list, processing every topic automatically.</span>
<span id="cb10-456"><a href="#cb10-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-457"><a href="#cb10-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-458"><a href="#cb10-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-461"><a href="#cb10-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-462"><a href="#cb10-462" aria-hidden="true" tabindex="-1"></a><span class="do">##-- county-level data</span></span>
<span id="cb10-463"><a href="#cb10-463" aria-hidden="true" tabindex="-1"></a>cnty_census_data <span class="ot">&lt;-</span> topic_list <span class="sc">%&gt;%</span></span>
<span id="cb10-464"><a href="#cb10-464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2</span>(topic, map_filename, <span class="cf">function</span>(t, f) {</span>
<span id="cb10-465"><a href="#cb10-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">build_acs_topic</span>(t, f, counties, state_code, target_years)</span>
<span id="cb10-466"><a href="#cb10-466" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb10-467"><a href="#cb10-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-468"><a href="#cb10-468" aria-hidden="true" tabindex="-1"></a><span class="do">##-- census tract data</span></span>
<span id="cb10-469"><a href="#cb10-469" aria-hidden="true" tabindex="-1"></a>tract_census_data <span class="ot">&lt;-</span> topic_list <span class="sc">%&gt;%</span></span>
<span id="cb10-470"><a href="#cb10-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2</span>(topic, map_filename, <span class="cf">function</span>(t, f) {</span>
<span id="cb10-471"><a href="#cb10-471" aria-hidden="true" tabindex="-1"></a>    <span class="fu">build_acs_topic</span>(t, f, <span class="at">counties =</span> lc_county, state_code, target_years, <span class="at">geo_level =</span> <span class="st">"tract"</span>)</span>
<span id="cb10-472"><a href="#cb10-472" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb10-473"><a href="#cb10-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-474"><a href="#cb10-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-475"><a href="#cb10-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-476"><a href="#cb10-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-477"><a href="#cb10-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-478"><a href="#cb10-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-479"><a href="#cb10-479" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Final Outputs and Storage</span></span>
<span id="cb10-480"><a href="#cb10-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-481"><a href="#cb10-481" aria-hidden="true" tabindex="-1"></a>The result of the pipeline is a **nested list** containing all our data. </span>
<span id="cb10-482"><a href="#cb10-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-483"><a href="#cb10-483" aria-hidden="true" tabindex="-1"></a>We can now:</span>
<span id="cb10-484"><a href="#cb10-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-485"><a href="#cb10-485" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Extract individual datasets (e.g., final_pop) for specific analysis.</span>
<span id="cb10-486"><a href="#cb10-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-487"><a href="#cb10-487" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Bind them together into a single combined dataframe</span>
<span id="cb10-488"><a href="#cb10-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-489"><a href="#cb10-489" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Export to CSV for future use like bringing them into a Shiny dashboard, Power BI, etc.</span>
<span id="cb10-490"><a href="#cb10-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-491"><a href="#cb10-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-492"><a href="#cb10-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-495"><a href="#cb10-495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-496"><a href="#cb10-496" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a named list for easy access</span></span>
<span id="cb10-497"><a href="#cb10-497" aria-hidden="true" tabindex="-1"></a>cnty_results_5yr  <span class="ot">&lt;-</span> <span class="fu">setNames</span>(cnty_census_data<span class="sc">$</span>data, cnty_census_data<span class="sc">$</span>topic)</span>
<span id="cb10-498"><a href="#cb10-498" aria-hidden="true" tabindex="-1"></a>tract_results_5yr <span class="ot">&lt;-</span> <span class="fu">setNames</span>(tract_census_data<span class="sc">$</span>data, tract_census_data<span class="sc">$</span>topic)</span>
<span id="cb10-499"><a href="#cb10-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-500"><a href="#cb10-500" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine them all into a single df</span></span>
<span id="cb10-501"><a href="#cb10-501" aria-hidden="true" tabindex="-1"></a>cnty_census_5yr_df  <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(cnty_results_5yr) </span>
<span id="cb10-502"><a href="#cb10-502" aria-hidden="true" tabindex="-1"></a>tract_census_5yr_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(tract_results_5yr) </span>
<span id="cb10-503"><a href="#cb10-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-504"><a href="#cb10-504" aria-hidden="true" tabindex="-1"></a>complete_census_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(cnty_census_5yr_df, tract_census_5yr_df) <span class="sc">%&gt;%</span></span>
<span id="cb10-505"><a href="#cb10-505" aria-hidden="true" tabindex="-1"></a><span class="do">##-- another custom function that calculates broader education categories like "BS or Higher"</span></span>
<span id="cb10-506"><a href="#cb10-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_education_summary</span>() </span>
<span id="cb10-507"><a href="#cb10-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-508"><a href="#cb10-508" aria-hidden="true" tabindex="-1"></a><span class="do">##-- you can also access/save them directly by name if you want</span></span>
<span id="cb10-509"><a href="#cb10-509" aria-hidden="true" tabindex="-1"></a>cnty_pop   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Population"</span>]]</span>
<span id="cb10-510"><a href="#cb10-510" aria-hidden="true" tabindex="-1"></a>cnty_house <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Housing"</span>]]</span>
<span id="cb10-511"><a href="#cb10-511" aria-hidden="true" tabindex="-1"></a>cnty_inc   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Income"</span>]]</span>
<span id="cb10-512"><a href="#cb10-512" aria-hidden="true" tabindex="-1"></a>cnty_edu   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Education"</span>]]</span>
<span id="cb10-513"><a href="#cb10-513" aria-hidden="true" tabindex="-1"></a>cnty_emp   <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Employment"</span>]]</span>
<span id="cb10-514"><a href="#cb10-514" aria-hidden="true" tabindex="-1"></a>cnty_hlth  <span class="ot">&lt;-</span> cnty_results_5yr[[<span class="st">"Health"</span>]]</span>
<span id="cb10-515"><a href="#cb10-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-516"><a href="#cb10-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-517"><a href="#cb10-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-518"><a href="#cb10-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-519"><a href="#cb10-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-520"><a href="#cb10-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-523"><a href="#cb10-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-524"><a href="#cb10-524" aria-hidden="true" tabindex="-1"></a><span class="co"># Save it for later use, bring in the other applications, etc...</span></span>
<span id="cb10-525"><a href="#cb10-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-526"><a href="#cb10-526" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb10-527"><a href="#cb10-527" aria-hidden="true" tabindex="-1"></a>  complete_census_df, </span>
<span id="cb10-528"><a href="#cb10-528" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">here</span>(<span class="st">"_data/census_data/complete_census_df.csv"</span>), </span>
<span id="cb10-529"><a href="#cb10-529" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb10-530"><a href="#cb10-530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-531"><a href="#cb10-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-532"><a href="#cb10-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>